# 服务组件性能测试方案

 撰写人：蔡振伟     版本：v 1.00   时间：20200119

## 一、目的

1、目前CM单机版在产品和项目使用比较多，运行整体稳定，故选此作为测试对标对象。通过主机和服务的参数调配，同等硬件配置下，统一管理平台提供的组件性能指标上应不低于CM版本。

2、测试过程中，可进一步深化对影响服务组件性能的参数集的理解。形成的知识经验可进一步指导，在不同应用场景下如何配置最优参数。

## 二、方案

### 2-1、机器配置

| 项   | 主机1                                                     | 主机2                                                        | 备注 |
| ---- | --------------------------------------------------------- | ------------------------------------------------------------ | ---- |
| IP   | 10.45.157.94                                              | 10.45.157.11                                                 |      |
| CPU  | Intel(R) Xeon(R) CPU E5-2670 v3 @ 2.30GHz*2<br />（48核） | Intel(R) Xeon(R) CPU E5-2670 v3 @ 2.30GHz*2<br />（48核）    |      |
| 内存 | 16G 2133MHz * 8                                           | 16G 2133MHz * 8                                              |      |
| 硬盘 | 数据盘：1T SAS 7200rpm *8                                 | 系统盘：300G SAS 10500rpm * 2<br />数据盘：1T SAS 7200rpm * 8 |      |
| OS   |                                                           |                                                              |      |

```shell
#cpu信息：
cat /proc/cpuinfo
```

```shell
#内存条信息：
dmidecode | grep -A16 "Memory Device$"
```



```shell
#硬盘信息：
fdisk -l |grep Disk
smartctl --all /dev/sda 
yum install sg3_utils
sginfo -g /dev/sda #转速
```

###  2-2、测试工具

#### 2-2-1、Apache JMeter

#### 2-2-2、HiBench

> HiBench is a big data benchmark suite that helps evaluate different big data frameworks in terms of speed, throughput and system resource utilizations. It contains a set of Hadoop, Spark and streaming workloads, including Sort, WordCount, TeraSort, Sleep, SQL, PageRank, Nutch indexing, Bayes, Kmeans, NWeight and enhanced DFSIO, etc. It also contains several streaming workloads for Spark Streaming, Flink, Storm and Gearpump.
>
> https://github.com/Intel-bigdata/HiBench.git
>
> 

> 目前的7.0版本支持：
>
> ### Supported Hadoop/Spark/Flink/Storm/Gearpump releases:
>
> - Hadoop: Apache Hadoop 2.x, **CDH5**, HDP
> - Spark: Spark 1.6.x, Spark 2.0.x, Spark 2.1.x, Spark 2.2.x
> - Flink: 1.0.3
> - Storm: 1.0.1
> - Gearpump: 0.8.1
> - Kafka: 0.8.2.2

做些版本的扩展，可以参考如下网址：https://github.com/stanislawbartkowski/MyHiBench.git

### 2-3、服务组件测试内容

#### 2-3-1、HDFS服务组件

##### HiBench编译

编译HiBench，支持hadoopbench框架

```shell
mvn -Phadoopbench -Dspark=2.1 -Dscala=2.11 clean package
#编译好的包，打包成一个版本，便于拷贝
tar -zcvf HiBench-7.1-SNAPSHOT_2.tar.gz --exclude=*.git HiBench/
```

问题：

1、apache-hive-0.14.0-bin.tar.gz下载太慢，通过http://ftp.oleane.net/pub/apache/dist/hive/hive-0.14.0/apache-hive-0.14.0-bin.tar.gz下载到本地仓库，修改xml文件（<HiBench_Root>/hadoopbench/sql/pom.xml)

```xml
<properties>
    <!--
    <repo>http://archive.apache.org</repo>
    <file>dist/hive/hive-0.14.0/apache-hive-0.14.0-bin.tar.gz</file>
    -->
    <repo>http://10.45.157.98</repo>
    <file>software/apache/hive/0.14.0/apache-hive-0.14.0-bin.tar.gz</file>
</properties>
```

2、apache-mahout-distribution-0.11.0.tar.gz下载过慢，通过https://mirrors.huaweicloud.com/apache/mahout/0.11.0/apache-mahout-distribution-0.11.0.tar.gz下载到本地仓库，修改xml文件（<HiBench_Root>/hadoopbench/mahout/pom.xml）

```xml
<properties>
    <!--
    <repo1>http://archive.apache.org</repo1>
    <file1>dist/mahout/0.11.0/apache-mahout-distribution-0.11.0.tar.gz</file1>
    -->
    <repo1>http://10.45.157.98</repo1>
    <file1>software/apache/mahout/0.11.0/apache-mahout-distribution-0.11.0.tar.gz</file1>
    <checksum1>32bb8d9429671c651ff8233676739f1f</checksum1>
    <repo2>http://archive.cloudera.com</repo2>
    <file2>cdh5/cdh/5/mahout-0.9-cdh5.1.0.tar.gz</file2>
    <checksum2>aa953e0353ac104a22d314d15c88d78f</checksum2>
</properties>
```

3、apache-nutch-1.2-bin.tar.gz下载过慢，通过http://apache.localhost.net.ar/nutch/apache-nutch-1.2-bin.tar.gz下载到本地仓库，修改xml文件（<HiBench_Root>/hadoopbench/nutchindexing/pom.xml）

```xml
<configuration>
    <!-- <url>http://archive.apache.org/dist/nutch/apache-nutch-1.2-bin.tar.gz</url> -->
    <url>http://10.45.157.98/software/apache/nutch//apache-nutch-1.2-bin.tar.gz</url>
</configuration>
```

##### 性能测试

创建和编辑conf/hadoop.conf

```
cp conf/hadoop.conf.template conf/hadoop.conf
```

```shell
# Hadoop home
#hibench.hadoop.home     /PATH/TO/YOUR/HADOOP/ROOT
hibench.hadoop.home  /usr/lib/hadoop

# The path of hadoop executable
hibench.hadoop.executable     ${hibench.hadoop.home}/bin/hadoop

# Hadoop configraution directory
hibench.hadoop.configure.dir  ${hibench.hadoop.home}/etc/hadoop

# The root HDFS path to store HiBench data
hibench.hdfs.master       hdfs://lv118.dct-znv.com:8020/user/root


# Hadoop release provider. Supported value: apache, cdh5, hdp
hibench.hadoop.release    cdh5
```

###### 测试项一：

生成测试数据 

```shell
 bin/workloads/micro/wordcount/prepare/prepare.sh
```

运行wordcount测试例子

```shell
 bin/workloads/micro/wordcount/hadoop/run.sh
```



#### Kafka组件

> 参考
>
> https://www.cnblogs.com/xiaodf/p/6023531.html
>
> https://www.infoq.cn/article/kafka-analysis-part-5

#### Spark组件

##### 修改hibench并编译

支持spark 2.3.x

sparkbench/pom.xml

```xml
    <!-- support spark 2.3 @czw-->
    <profile>
      <id>spark2.3</id>
      <properties>
        <spark.version>2.3.0</spark.version>
        <spark.bin.version>2.3</spark.bin.version>
      </properties>
      <activation>
        <property>
          <name>spark</name>
          <value>2.3</value>
        </property>
      </activation>
    </profile>
```

sparkbench/streaming/pom.xml

```xml
    <!-- support spark 2.3 @czw-->  
    <profile>
      <id>spark2.3</id>
      <dependencies>
        <dependency>
          <groupId>org.apache.spark</groupId>
          <artifactId>spark-streaming-kafka-0-8_2.11</artifactId>
          <version>2.3.0</version>
        </dependency>
      </dependencies>
      <activation>
        <property>
          <name>spark</name>
          <value>2.3</value>
        </property>
      </activation>
    </profile>
```

sparkbench/structuredStreaming/pom.xml

```xml
    <!-- support spark 2.3 @czw-->
    <profile>
      <id>spark2.3</id>
      <dependencies>
        <dependency>
          <groupId>org.apache.spark</groupId>
          <artifactId>spark-streaming-kafka-0-8_${scala.binary.version}</artifactId>
          <version>2.3.0</version>
        </dependency>
        <dependency>
          <groupId>org.apache.spark</groupId>
          <artifactId>spark-sql-kafka-0-10_${scala.binary.version}</artifactId>
          <version>2.3.0</version>
        </dependency>
      </dependencies>
      <activation>
        <property>
          <name>spark</name>
          <value>2.3</value>
        </property>
      </activation>
    </profile>
```

编译

```shell
mvn  -Psparkbench -Dspark=2.3 -Dscala=2.11 clean package
#编译好的包，打包成一个版本，便于拷贝
tar -zcvf HiBench-7.1-SNAPSHOT_3.tar.gz --exclude=*.git HiBench/
```



####ES组件

> 方案参考：https://segmentfault.com/a/1190000011174694

